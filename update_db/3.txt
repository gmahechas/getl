CREATE VIEW `invoice_time_avg` AS
SELECT ins.*,
		(SELECT IFNULL(SUM(sub_ins.invoice_status_date_diff),0)
		 FROM invoice_status_view sub_ins
		 WHERE sub_ins.invoice_id_ref = ins.invoice_id_ref AND sub_ins.status_id NOT IN(10,11)) AS duration
FROM invoice_status_view ins





USE `getl`;
CREATE
     OR REPLACE ALGORITHM = UNDEFINED
    DEFINER = `root`@`localhost`
    SQL SECURITY DEFINER
VIEW `invoice_time_avg` AS
    SELECT
        `ins`.`id` AS `id`,
        `ins`.`invoice_status_date` AS `invoice_status_date`,
        `ins`.`invoice_status_responsable` AS `invoice_status_responsable`,
        `ins`.`invoice_id_ref` AS `invoice_id_ref`,
        `ins`.`status_id` AS `status_id`,
        `ins`.`status_description` AS `status_description`,
        `ins`.`status_order` AS `status_order`,
        `ins`.`invoice_status_date_end` AS `invoice_status_date_end`,
        `ins`.`invoice_status_date_diff` AS `invoice_status_date_diff`,
        (SELECT
                IFNULL(SUM(`sub_ins`.`invoice_status_date_diff`),
                            0)
            FROM
                `invoice_status_view` `sub_ins`
            WHERE
                `sub_ins`.`invoice_id_ref` = `ins`.`invoice_id_ref`
                    AND `sub_ins`.`status_id` NOT IN (10 , 11)) AS `duration`
    FROM
        `invoice_status_view` `ins`;

